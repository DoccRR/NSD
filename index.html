<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>NSD Snake + Carrusel</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: black;
      font-family: 'Orbitron', sans-serif;
      color: white;
      overflow: hidden;
    }

    /* ======================= Carrusel ======================= */
    .carousel-container {
      display: flex;
      overflow-x: hidden;
      scroll-behavior: smooth;
      width: 100%;
      height: 100vh;
    }
    .slide {
      min-width: 100%;
      height: 100vh;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }

    /* ======================= Flechas carrusel ======================= */
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 3rem;
      color: white;
      background: rgba(0,0,0,0.5);
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      z-index: 10;
      user-select: none;
    }
    .arrow.left { left: 10px; }
    .arrow.right { right: 10px; }

    /* ======================= Snake ======================= */
    #snakeWrap {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    #snakeCanvas {
      background: black;
      border: 2px solid white;
      display: block;
    }
    #score {
      margin-top: 10px;
      font-size: 20px;
    }

    /* ======================= Overlay Game Over ======================= */
    #gameOverOverlay {
      display: none;
      position: absolute;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      z-index: 30;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #gameOverOverlay input {
      margin-top: 10px;
      padding: 5px;
      font-size: 16px;
      font-family: Orbitron;
      text-align: center;
    }
    #gameOverOverlay button {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }

    /* ======================= Controles de música ======================= */
    #musicControls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 50;
      background: rgba(0,0,0,0.5);
      padding: 8px 12px;
      border-radius: 8px;
    }
    #musicControls button {
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
      background: none;
      border: 1px solid white;
      color: white;
      border-radius: 4px;
    }
    #musicControls input[type=range] {
      width: 100px;
    }
  </style>
</head>
<body>

  <!-- ======================= Carrusel con imágenes ======================= -->
  <div class="carousel-container">
    <div class="slide" style="background-image:url('instagram.png')"></div>
    <div class="slide" style="background-image:url('bookings.png')"></div>
    <div class="slide" style="background-image:url('spotify.png')"></div>
    <div class="slide" style="background-image:url('soundcloud.png')"></div>
    <div class="slide" style="background-image:url('merch.png')"></div>
    <div class="slide" style="background-image:url('youtube.png')"></div>
    <div class="slide" style="background-image:url('bandcamp.png')"></div>
  </div>

  <!-- Flechas -->
  <button class="arrow left" onclick="scrollCarousel(-1)">&#10094;</button>
  <button class="arrow right" onclick="scrollCarousel(1)">&#10095;</button>

  <!-- ======================= Snake ======================= -->
  <div id="snakeWrap">
    <canvas id="snakeCanvas"></canvas>
    <div id="score">SCORE: 0</div>
  </div>

  <!-- ======================= Overlay Game Over ======================= -->
  <div id="gameOverOverlay">
    <h2>GAME OVER</h2>
    <input id="nicknameInput" type="text" placeholder="Tu nombre...">
    <button id="playAgainBtn">JUGAR DE NUEVO</button>
  </div>

  <!-- ======================= Controles SoundCloud ======================= -->
  <div id="musicControls">
    <button id="prevBtn">⏮</button>
    <button id="playPauseBtn">▶</button>
    <button id="nextBtn">⏭</button>
    <input type="range" id="volumeSlider" min="0" max="100" value="50">
  </div>

  <!-- Reproductor SoundCloud oculto -->
  <iframe 
    id="scPlayer"
    style="display:none;"
    width="0" height="0"
    src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/yourplaylist&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=false">
  </iframe>

  <!-- Scripts externos -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://w.soundcloud.com/player/api.js"></script>

<script>
/* ======================= Firebase ======================= */
const firebaseConfig = {
  apiKey: "AIzaSyANmEBw9kBijdWHmxV5cIBHy1patcfAuvA",
  authDomain: "nsdsnake.firebaseapp.com",
  projectId: "nsdsnake",
  storageBucket: "nsdsnake.firebasestorage.app",
  messagingSenderId: "719565977829",
  appId: "1:719565977829:web:94911f469efd29aa9c7c0c",
  databaseURL: "https://nsdsnake-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ======================= Snake ======================= */
const canvas = document.getElementById("snakeCanvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("gameOverOverlay");
const scoreEl = document.getElementById("score");
const nicknameInput = document.getElementById("nicknameInput");
const playAgainBtn = document.getElementById("playAgainBtn");

let GRID = 20;        // celdas por lado (20x20)
let box = 20;         // tamaño de celda en CSS px (se recalcula)
let snake = [];
let direction = null;
let food = null;
let score = 0;
let loop = null;
let lastSaveAt = 0;

function sanitize(str){
  return String(str).replace(/[<>]/g,"").trim().slice(0, 20) || "Anon";
}

function setCanvasSquareToContainer(){
  // Calcula el tamaño cuadrado máximo disponible dentro del #snakeWrap
  const wrap = document.getElementById("snakeWrap");
  const rect = wrap.getBoundingClientRect();
  const sizeCSS = Math.min(rect.width - 16, rect.height - 16); // padding aprox
  // box = tamaño por celda en CSS px para que cuadre con GRID
  box = Math.max(10, Math.floor(sizeCSS / GRID));
  const cssSize = box * GRID;

  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = cssSize + "px";
  canvas.style.height = cssSize + "px";
  canvas.width = Math.floor(cssSize * dpr);
  canvas.height = Math.floor(cssSize * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function generateFood(){
  const letters = ["N","S","D"];
  return {
    x: Math.floor(Math.random() * GRID) * box,
    y: Math.floor(Math.random() * GRID) * box,
    letter: letters[Math.floor(Math.random() * letters.length)]
  };
}

function resetSnake(){
  // centra la serpiente
  const cx = Math.floor(GRID/2) * box;
  const cy = Math.floor(GRID/2) * box;
  snake = [{ x: cx, y: cy }];
  direction = null;
}

function draw(){
  // fondo
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, box*GRID, box*GRID);

  // serpiente
  for(let i=0;i<snake.length;i++){
    ctx.fillStyle = (i===0) ? "lime" : "white";
    ctx.fillRect(snake[i].x, snake[i].y, box, box);
  }
  // comida
  ctx.fillStyle = "white";
  ctx.font = Math.floor(box*0.9) + "px Orbitron";
  ctx.fillText(food.letter, food.x + Math.floor(box*0.2), food.y + Math.floor(box*0.8));

  // siguiente cabeza
  let head = { x: snake[0].x, y: snake[0].y };
  if(direction === "LEFT")  head.x -= box;
  if(direction === "UP")    head.y -= box;
  if(direction === "RIGHT") head.x += box;
  if(direction === "DOWN")  head.y += box;

  // comer
  if(head.x === food.x && head.y === food.y){
    score++;
    scoreEl.textContent = "SCORE: " + score;
    food = generateFood();
  } else {
    snake.pop();
  }

  // colisiones
  const hitWall = head.x < 0 || head.x >= box*GRID || head.y < 0 || head.y >= box*GRID;
  const hitSelf = snake.some(p => p.x === head.x && p.y === head.y);
  if(hitWall || hitSelf){
    clearInterval(loop);
    overlay.style.display = "flex";
    return;
  }
  snake.unshift(head);
}

function startGame(){
  setCanvasSquareToContainer();
  resetSnake();
  food = generateFood();
  score = 0;
  scoreEl.textContent = "SCORE: 0";
  overlay.style.display = "none";
  if(loop) clearInterval(loop);
  loop = setInterval(draw, 100);
}

window.addEventListener("resize", ()=>{
  const wasRunning = !!loop && overlay.style.display === "none";
  // al redimensionar, reiniciamos para no distorsionar posiciones
  if(loop) clearInterval(loop);
  startGame();
  if(!wasRunning) { clearInterval(loop); }
});

document.addEventListener("keydown",(e)=>{
  // Evita scroll de la página con flechas/espacio
  if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "].includes(e.key)) e.preventDefault();
  if(e.key === "ArrowLeft"  && direction !== "RIGHT") direction = "LEFT";
  else if(e.key === "ArrowUp"    && direction !== "DOWN")  direction = "UP";
  else if(e.key === "ArrowRight" && direction !== "LEFT")  direction = "RIGHT";
  else if(e.key === "ArrowDown"  && direction !== "UP")    direction = "DOWN";
});

playAgainBtn.addEventListener("click", async ()=>{
  // guarda si hay puntuación y nickname válido
  if(score > 0){
    const now = Date.now();
    if(now - lastSaveAt > 2000){ // antispam básico
      lastSaveAt = now;
      const nick = sanitize(nicknameInput.value);
      const safeScore = Math.min(Math.max(score, 0), 9999);
      try{
        await db.ref("scores").push({
          nickname: nick,
          score: safeScore,
          timestamp: now
        });
      }catch(e){ console.warn("Firebase write error:", e); }
    }
  }
  nicknameInput.value = "";
  startGame();
});

startGame();

/* ======================= Ranking global ======================= */
const rankingDiv = document.createElement("div");
rankingDiv.id = "ranking";
rankingDiv.style.position = "absolute";
rankingDiv.style.bottom = "160px";
rankingDiv.style.left = "50%";
rankingDiv.style.transform = "translateX(-50%)";
rankingDiv.style.color = "white";
rankingDiv.style.fontSize = "14px";
rankingDiv.style.textAlign = "center";
rankingDiv.style.background = "rgba(0,0,0,0.6)";
rankingDiv.style.padding = "6px 12px";
rankingDiv.style.borderRadius = "8px";
rankingDiv.style.maxWidth = "90%";
document.body.appendChild(rankingDiv);

function escapeHTML(s){
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function loadRanking(){
  db.ref("scores").orderByChild("score").limitToLast(5).on("value", snap=>{
    const arr = [];
    snap.forEach(ch => arr.push(ch.val()));
    arr.sort((a,b)=>b.score - a.score);
    rankingDiv.innerHTML = "<b>TOP 5 PLAYERS</b><br>" + arr
      .map(s => `${escapeHTML(s.nickname||"Anon")}: ${Number(s.score)||0}`)
      .join("<br>");
  });
}
loadRanking();

/* ======================= Carrusel (flechas + rueda + swipe) ======================= */
const container = document.querySelector(".carousel-container");
let currentIndex = 0;

function getSlideWidth(){
  const slides = document.querySelectorAll(".slide");
  if(!slides.length) return 0;
  const s0 = slides[0];
  const rect = s0.getBoundingClientRect();
  const cs = getComputedStyle(s0);
  const margin = parseFloat(cs.marginLeft) + parseFloat(cs.marginRight);
  return rect.width + margin;
}

function clampIndex(i){
  const slides = document.querySelectorAll(".slide");
  return Math.max(0, Math.min(i, slides.length - 1));
}

function scrollCarousel(dir){
  const slideW = getSlideWidth();
  if(!slideW) return;
  currentIndex = clampIndex(currentIndex + dir);
  container.scrollTo({ left: Math.round(currentIndex * slideW), behavior: "smooth" });
}
window.scrollCarousel = scrollCarousel; // para las flechas onclick del HTML

let touchStartX = 0;
container.addEventListener("touchstart", e => { touchStartX = e.changedTouches[0].screenX; }, { passive:true });
container.addEventListener("touchend", e => {
  const dx = e.changedTouches[0].screenX - touchStartX;
  if(dx > 50) scrollCarousel(-1);
  else if(dx < -50) scrollCarousel(1);
}, { passive:true });

// Rueda del ratón para navegar slides
container.addEventListener("wheel", (e)=>{
  e.preventDefault();
  if(e.deltaY > 0) scrollCarousel(1); else scrollCarousel(-1);
}, { passive:false });

// Recalcular índice relativo al desplazamiento tras resize
window.addEventListener("resize", ()=>{
  const slideW = getSlideWidth();
  if(!slideW) return;
  currentIndex = Math.round(container.scrollLeft / slideW);
});

/* ======================= SoundCloud (iframe oculto + controles) ======================= */
const scIframe = document.getElementById("scPlayer"); // oculto (display:none; width/height 0)
const scWidget = SC.Widget(scIframe);

let widgetReady = false;
let isPlaying = false;

const playPauseBtn = document.getElementById("playPauseBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const volumeSlider = document.getElementById("volumeSlider");

playPauseBtn.disabled = true;
prevBtn.disabled = true;
nextBtn.disabled = true;
volumeSlider.disabled = true;

scWidget.bind(SC.Widget.Events.READY, function(){
  widgetReady = true;
  // habilitar controles
  playPauseBtn.disabled = false;
  prevBtn.disabled = false;
  nextBtn.disabled = false;
  volumeSlider.disabled = false;
  scWidget.setVolume(parseInt(volumeSlider.value,10));
});

scWidget.bind(SC.Widget.Events.PLAY, function(){
  isPlaying = true;
  playPauseBtn.textContent = "⏸";
});
scWidget.bind(SC.Widget.Events.PAUSE, function(){
  isPlaying = false;
  playPauseBtn.textContent = "▶";
});
scWidget.bind(SC.Widget.Events.FINISH, function(){
  isPlaying = false;
  playPauseBtn.textContent = "▶";
});

playPauseBtn.addEventListener("click", ()=>{
  if(!widgetReady) return;
  if(isPlaying) scWidget.pause(); else scWidget.play();
});
prevBtn.addEventListener("click", ()=>{ if(widgetReady) scWidget.prev(); });
nextBtn.addEventListener("click", ()=>{ if(widgetReady) scWidget.next(); });
volumeSlider.addEventListener("input", (e)=>{
  if(widgetReady) scWidget.setVolume(parseInt(e.target.value,10));
});

</script>

